# [Feature] 解析済みシナリオデータのバリデーションとDB保存

## 概要

Issue #4の対応として、画像解析で取得したシナリオデータをユーザーが確認・編集し、データベースへ一括保存する機能を実装しました。重複チェック、トランザクション処理、WAVE EXの特別処理なども含まれています。

## 実施内容

### 1. 解析結果の編集UIの実装

- **編集可能なフォーム**: 解析結果をそのまま表示するのではなく、すべての項目を編集可能なフォームとして実装
- **基本情報の編集**: シナリオコード、ステージ、キケン度、スコアを編集可能
- **武器情報の編集**: 武器名を個別に編集可能
- **WAVE情報の編集**: 各WAVEの潮位、イベント、納品数、ノルマ、クリア状態を編集可能
- **リアルタイムバリデーション**: 必須項目の検証と数値範囲のチェック

### 2. シナリオ保存APIエンドポイントの実装

- **エンドポイント**: `/api/scenarios`
- **メソッド**: POST
- **認証**: 認証済みユーザーのみ保存可能

**主な機能**:
- **重複チェック**: `scenario_code`が既に存在する場合は409エラーを返す
- **トランザクション処理**: `scenarios`、`scenario_waves`、`scenario_weapons`テーブルへのアトミックな保存
- **ロールバック機能**: いずれかのテーブルへの保存が失敗した場合、既に保存されたデータを自動的にロールバック
- **マスタデータ名寄せ**: ステージ名・武器名をマスタIDに自動変換
- **WAVE EXの特別処理**: WAVE EXの場合はイベントを「オカシラ」に固定、納品数・ノルマに適切なデフォルト値を設定

### 3. WAVE EXの特別処理

- **UI側の処理**:
  - WAVE EXの場合、納品数とノルマのフィールドを非表示
  - イベントを「オカシラ」に固定（プルダウンをdisabled）
  - 解析時にWAVE EXのイベントを自動的に「オカシラ」に設定

- **保存API側の処理**:
  - WAVE EXの場合、イベントを「オカシラ」に強制設定
  - 納品数: 0（データベース制約を満たすため）
  - ノルマ: 1（データベース制約を満たすため）

### 4. ステージ選択のプルダウン化

- **ステージ一覧取得API**: `/api/stages`エンドポイントを新規作成
- **プルダウンUI**: テキスト入力からプルダウン選択に変更
- **マスタデータ連携**: データベースの`m_stages`テーブルからステージ一覧を取得
- **コンポーネントマウント時に自動取得**: ステージ一覧を事前に取得してプルダウンに表示

### 5. イベント選択のプルダウン化

- **イベント選択肢**: 以下のイベントをプルダウンで選択可能
  - なし
  - ハコビヤ襲来
  - キンシャケ探し
  - グリル発進
  - ドスコイ大量発生
  - ラッシュ
  - 霧
- **WAVE EXの固定**: WAVE EXの場合は「オカシラ」に固定（選択不可）

### 6. エラーハンドリングとユーザーフィードバック

- **重複エラー**: シナリオコードが既に存在する場合、適切なエラーメッセージを表示
- **バリデーションエラー**: 必須項目や数値範囲のエラーを表示
- **サーバーエラー**: 保存処理中のエラーを適切に処理
- **成功メッセージ**: 保存成功時にメッセージを表示し、1.5秒後にホームページへリダイレクト
- **null値の処理**: `input`要素の`value`プロパティに`null`が渡される問題を修正

## 技術的な実装詳細

### トランザクション処理

SupabaseはPostgreSQLのトランザクションを直接サポートしていないため、手動でロールバック処理を実装：

1. `scenarios`テーブルに保存
2. `scenario_waves`テーブルに保存（失敗時は`scenarios`を削除）
3. `scenario_weapons`テーブルに保存（失敗時は`scenario_waves`と`scenarios`を削除）

### 重複チェック

- `scenarios`テーブルから`scenario_code`で検索
- 既に存在する場合は409 Conflictエラーを返す
- エラーメッセージに具体的なシナリオコードを表示

### 型安全性

- TypeScriptの厳格モードを使用
- `any`型の使用を避け、明示的な型定義を実装
- データベース型定義（`Database`型）を活用

## 変更ファイル

### 新規作成
- `app/api/scenarios/route.ts` - シナリオ保存APIエンドポイント
- `app/api/stages/route.ts` - ステージ一覧取得APIエンドポイント
- `PR_DESCRIPTION_ISSUE4.md` - 本PR説明文

### 更新
- `app/components/ImageAnalyzer.tsx` - 編集UI、WAVE EX処理、プルダウン化、エラーハンドリングの追加

## UI/UXの改善

- **編集可能なフォーム**: 解析結果をそのまま保存するのではなく、ユーザーが確認・修正できるUI
- **視覚的フィードバック**: 保存中状態、成功メッセージ、エラーメッセージの表示
- **直感的な操作**: プルダウン選択による入力ミスの削減
- **WAVE EXの特別表示**: WAVE EXの場合、不要な項目を非表示にしてUIを簡潔に

## データベース整合性

- **外部キー制約**: ステージID、武器IDの参照整合性を保証
- **NOT NULL制約**: 必須項目の欠落を防止
- **CHECK制約**: キケン度（0-333）、WAVE番号（1-3）などの範囲チェック
- **トランザクション**: 複数テーブルへの保存をアトミックに実行

## エラーハンドリング

### クライアント側
- ネットワークエラーの処理
- バリデーションエラーの表示
- 保存中状態の管理

### サーバー側
- 認証エラー（401）
- 重複エラー（409）
- バリデーションエラー（400）
- サーバーエラー（500）
- ロールバック処理

## 使用例

1. 画像をアップロードして解析
2. 解析結果が編集可能なフォームとして表示される
3. 必要に応じて各項目を編集
4. ステージとイベントはプルダウンから選択
5. WAVE EXの場合は、納品数・ノルマが非表示、イベントが「オカシラ」に固定
6. 「保存する」ボタンをクリック
7. 重複チェックが実行される
8. トランザクション処理でデータベースに保存
9. 成功メッセージが表示され、ホームページへリダイレクト

## 今後の拡張可能性

- 詳細ページへのリダイレクト（詳細ページ実装後）
- 保存前の最終確認ダイアログ
- 保存履歴の表示
- 一括編集機能
- バリデーションルールの拡張

## 関連Issue

Closes #4

## 備考

- WAVE EXの`wave_number`はデータベース保存時に3に変換されます（データベース制約のため）
- ステージ一覧はコンポーネントマウント時に一度だけ取得されます
- 保存処理は認証済みユーザーのみ実行可能です

