# [Feature] シナリオ一覧（カード形式）と検索フィルターの実装

## 概要

Issue #5の対応として、シナリオ一覧をカード形式で表示し、ステージ・武器・キケン度によるフィルター機能を実装しました。また、画像解析機能を別ページ（`/analyze`）に分離し、メインページをシナリオ一覧専用にしました。

## 実施内容

### 1. シナリオ一覧ページの実装

- **カード形式の表示**: グリッドレイアウトでシナリオをカード形式で表示
- **レスポンシブデザイン**: 
  - モバイル: 1列
  - タブレット: 2列
  - デスクトップ: 3列
  - 大型デスクトップ: 4列
- **カード情報の表示**:
  - シナリオコード（目立つように表示）
  - ステージ名
  - キケン度
  - 合計金イクラ数（目立つように表示）
  - 武器アイコン（最大4つ、不足時は空スロット表示）

### 2. フィルター機能の実装

#### ステージフィルター
- **実装方式**: セレクトボックス
- **動作**: ステージ選択時に即座にフィルターを適用
- **データソース**: `/api/stages`エンドポイントから取得

#### 武器フィルター
- **実装方式**: アイコン選択のマルチセレクト
- **動作**: 複数の武器を選択可能、選択中の武器数を表示
- **フィルターロジック**: **指定された武器IDをすべて含むシナリオのみを表示**（AND条件）
- **データソース**: `/api/weapons`エンドポイントから取得
- **UI**: 武器アイコンをクリックで選択/解除、選択中は青色でハイライト

#### キケン度フィルター
- **実装方式**: 数値入力（最小値指定）
- **動作**: 指定したキケン度以上のシナリオを表示
- **範囲**: 0-333%

### 3. ScenarioCardコンポーネントの実装

- **表示項目**:
  - シナリオコード（大見出し）
  - ステージ名（小文字）
  - キケン度（赤色で強調）
  - 合計金イクラ数（黄色で強調、大きく表示）
  - 武器アイコン（最大4つ、`display_order`順）
- **空スロット表示**: 武器が4つ未満の場合、ダッシュ記号で空スロットを表示
- **画像フォールバック**: 武器アイコンが読み込めない場合、武器名をテキストで表示
- **ホバーエフェクト**: カードにマウスオーバー時にボーダー色が変化

### 4. GET /api/scenarios エンドポイントの実装

- **機能**: シナリオ一覧を取得し、フィルター条件に応じて絞り込み
- **クエリパラメータ**:
  - `stage_id`: ステージIDでフィルター
  - `weapon_ids`: 武器IDのカンマ区切り（例: `1,2,3`）
  - `min_danger_rate`: キケン度の最小値
- **データ取得**:
  - `scenarios`テーブルと`m_stages`テーブルをJOIN
  - `scenario_weapons`テーブルと`m_weapons`テーブルをJOIN
  - 武器情報は`display_order`順でソート
- **武器フィルターロジック**:
  - 指定された武器IDを**すべて含む**シナリオのみを返す（AND条件）
  - 各シナリオの武器IDリストと比較し、すべての指定武器IDが含まれているかチェック
- **レスポンス形式**:
  ```typescript
  {
    success: boolean
    data?: ScenarioListItem[]
    error?: string
  }
  ```

### 5. ページ構成の変更

- **メインページ（`/`）**: シナリオ一覧とフィルターを表示
- **画像解析ページ（`/analyze`）**: 画像解析機能を分離
- **ナビゲーション**: メインページから画像解析ページへのリンクを追加

### 6. 空状態の表示

- **検索結果が0件の場合**:
  - 「シナリオが見つかりませんでした」メッセージを表示
  - 「フィルター条件を変更して再度検索してください」の案内を表示

### 7. エラーハンドリング

- **マスタデータ取得エラー**: エラーメッセージを表示
- **シナリオ一覧取得エラー**: エラーメッセージを表示
- **ローディング状態**: データ取得中は「読み込み中...」を表示

## 技術的な実装詳細

### 武器フィルターロジック

```typescript
// 指定された武器IDをすべて含むシナリオのみを抽出
if (weaponIds && weaponIds.length > 0) {
  filteredScenarioCodes = scenarioCodes.filter((code) => {
    const scenarioWeaponIds = typedScenarioWeapons
      .filter((sw) => sw.scenario_code === code)
      .map((sw) => sw.weapon_id)
    // 指定された武器IDをすべて含むかチェック
    return weaponIds.every((weaponId) => scenarioWeaponIds.includes(weaponId))
  })
}
```

この実装により、複数の武器を選択した場合、**すべての武器を含むシナリオのみ**が表示されます。

### 型安全性

- TypeScriptの厳格モードを使用
- Supabaseのクエリ結果に対して型アサーションを実装
- 明示的な型定義（`ScenarioListItem`, `ScenarioCardProps`など）

### パフォーマンス

- マスタデータ（ステージ、武器）はコンポーネントマウント時に一度だけ取得
- シナリオ一覧はフィルター条件変更時にのみ再取得
- `useEffect`の依存配列を適切に設定し、不要な再レンダリングを防止

## 変更ファイル

### 新規作成
- `app/components/ScenarioCard.tsx` - シナリオカードコンポーネント
- `app/components/__tests__/ScenarioCard.test.tsx` - ScenarioCardのテスト
- `app/api/__tests__/scenarios.test.ts` - GET /api/scenariosのテスト
- `app/analyze/page.tsx` - 画像解析ページ
- `PR_DESCRIPTION_ISSUE5.md` - 本PR説明文

### 更新
- `app/page.tsx` - シナリオ一覧ページに変更（フィルター機能追加）
- `app/api/scenarios/route.ts` - GETエンドポイントを追加（フィルター対応）
- `app/__tests__/page.test.tsx` - 新しいページ構造に合わせてテストを更新
- `app/components/ImageAnalyzer.tsx` - プレビューURLのクリーンアップとAbortControllerの実装

## UI/UXの改善

- **視覚的な情報表示**: カード形式により、シナリオ情報を一目で把握可能
- **直感的なフィルター操作**: セレクトボックス、アイコン選択、数値入力による簡単な操作
- **リアルタイムフィルタリング**: フィルター条件変更時に即座に結果を更新
- **空状態の適切な表示**: 検索結果が0件の場合、ユーザーに分かりやすいメッセージを表示
- **レスポンシブデザイン**: 様々な画面サイズに対応

## テスト

### コンポーネントテスト
- `ScenarioCard`コンポーネントのテスト:
  - シナリオコードと合計金イクラ数の表示
  - ステージ名とキケン度の表示
  - 武器アイコンの表示
  - 空スロットの表示
  - アイコンURLがnullの場合のフォールバック

### APIテスト
- `GET /api/scenarios`エンドポイントのテスト:
  - シナリオが存在しない場合の空配列返却
  - ステージIDによるフィルター
  - キケン度によるフィルター
  - 武器IDによるフィルター（すべてを含むロジック）
  - データベースエラーのハンドリング

### ページテスト
- メインページのテスト:
  - メイン見出しの表示
  - フィルターセクションの表示
  - 画像解析ページへのリンク
  - マスタデータの取得
  - シナリオ一覧の取得

## 使用例

1. メインページ（`/`）にアクセス
2. フィルターセクションで条件を設定:
   - ステージを選択（例: 「アラマキ砦」）
   - 武器を複数選択（例: 「スプラシューター」「スプラローラー」）
   - キケン度の最小値を入力（例: 200）
3. フィルター条件に一致するシナリオがカード形式で表示される
4. 各カードにはシナリオコード、ステージ名、キケン度、合計金イクラ数、武器アイコンが表示される
5. 検索結果が0件の場合、適切なメッセージが表示される

## 今後の拡張可能性

- シナリオカードのクリックで詳細ページへ遷移
- ソート機能（キケン度、合計金イクラ数、作成日時など）
- ページネーション（大量のシナリオに対応）
- お気に入り機能
- エクスポート機能（CSV、JSONなど）
- 高度なフィルター（日付範囲、作成者など）

## 関連Issue

Closes #5

## 備考

- 武器フィルターは「すべてを含む」（AND条件）で動作します
- シナリオ一覧は作成日時の降順でソートされています
- 武器アイコンが読み込めない場合、武器名がテキストで表示されます
- 画像解析機能は`/analyze`ページに移動しました

