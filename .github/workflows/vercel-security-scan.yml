name: Vercel Security Scan

on:
  workflow_run:
    workflows: ["Deploy to Vercel"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        type: string
      environment:
        description: 'Environment type (preview or production)'
        required: false
        type: choice
        options:
          - preview
          - production
        default: preview

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: OWASP ZAP Security Scan
    # PRæ™‚ã¾ãŸã¯mainãƒ–ãƒ©ãƒ³ãƒpushæ™‚ã«å®Ÿè¡Œ
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.event == 'pull_request' ||
        (github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main')))
    permissions:
      contents: read
      pull-requests: write
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine scan environment
        id: scan_env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            if [ -z "$ENV" ]; then
              ENV="preview"
            fi
            echo "environment=$ENV" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.event }}" == "pull_request" ]; then
            echo "environment=preview" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.event }}" == "push" ] && [ "${{ github.event.workflow_run.head_branch }}" == "main" ]; then
            # mainãƒ–ãƒ©ãƒ³ãƒã®pushæ™‚ã¯æœ¬ç•ªç’°å¢ƒ
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=preview" >> $GITHUB_OUTPUT
          fi
          
          echo "Scan environment: ${{ steps.scan_env.outputs.environment }}"

      - name: Get PR number from workflow run
        id: pr_number
        if: github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // workflow_runã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰PRç•ªå·ã‚’å–å¾—
            const pullRequests = ${{ toJSON(github.event.workflow_run.pull_requests) }};
            const prNumber = pullRequests && pullRequests.length > 0 ? pullRequests[0].number : null;
            
            if (!prNumber) {
              core.setFailed('PR number not found in workflow_run event');
              return;
            }
            
            core.setOutput('pr_number', prNumber);

      - name: Get Vercel Preview URL from PR comments
        id: vercel_preview_url
        if: github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr_number.outputs.pr_number }};
            
            // PRã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰Vercelã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’å–å¾—
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
            });
            
            // Vercelã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å–å¾—
            const vercelComment = comments.find(comment => 
              comment.body && comment.body.includes('vercel.app')
            );
            
            if (vercelComment) {
              const urlMatch = vercelComment.body.match(/https:\/\/[^\s]+\.vercel\.app/);
              if (urlMatch) {
                core.setOutput('url', urlMatch[0]);
                return;
              }
            }
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å–å¾—ã§ããªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
            const defaultUrl = `https://salmon-run-scenario-hub-git-${prNumber}-eddie-splatoons-projects.vercel.app`;
            core.setOutput('url', defaultUrl);

      - name: Get Vercel Production URL
        id: vercel_production_url
        if: steps.scan_env.outputs.environment == 'production'
        run: |
          # æœ¬ç•ªç’°å¢ƒã®URLã‚’å–å¾—
          # Vercelã®æœ¬ç•ªç’°å¢ƒURLã¯é€šå¸¸ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã«åŸºã¥ã„ã¦æ±ºå®šã•ã‚Œã‚‹
          PROD_URL="https://salmon-run-scenario-hub.vercel.app"
          echo "url=$PROD_URL" >> $GITHUB_OUTPUT
          echo "Production URL: $PROD_URL"

      - name: Set target URL
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
          elif [ "${{ steps.scan_env.outputs.environment }}" == "production" ]; then
            echo "url=${{ steps.vercel_production_url.outputs.url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ steps.vercel_preview_url.outputs.url }}" >> $GITHUB_OUTPUT
          fi
          
          echo "Target URL: ${{ steps.target.outputs.url }}"
          echo "Environment: ${{ steps.scan_env.outputs.environment }}"

      - name: Wait for deployment to be ready
        if: github.event_name == 'workflow_run'
        run: |
          echo "Waiting for Vercel deployment to be ready..."
          MAX_RETRIES=20
          RETRY_COUNT=0
          TARGET_URL="${{ steps.target.outputs.url }}"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s -o /dev/null "$TARGET_URL"; then
              echo "Deployment is ready!"
              exit 0
            fi
            echo "Waiting for deployment... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          
          echo "Warning: Deployment may not be ready, proceeding with scan anyway"

      - name: ZAP Baseline Scan
        id: zap_scan
        uses: zaproxy/action-baseline@v0.12.0
        continue-on-error: true
        with:
          target: ${{ steps.target.outputs.url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J'
          fail_action: false

      - name: Check if SARIF file exists
        id: check_sarif
        if: always()
        run: |
          if [ -f zap_report.sarif ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Archive ZAP results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report-${{ steps.scan_env.outputs.environment }}-${{ github.run_number }}
          path: |
            zap_report.html
            zap_report.json
            zap_report.md
            zap_report.sarif
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload ZAP results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.check_sarif.outputs.exists == 'true'
        continue-on-error: true
        with:
          sarif_file: zap_report.sarif
          wait-for-processing: true

      - name: Parse ZAP scan results
        id: parse_results
        if: always()
        run: |
          # zap_report.jsonã‹ã‚‰çµæžœã‚’è§£æž
          if [ -f zap_report.json ]; then
            # é‡å¤§ãªå•é¡Œã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            HIGH_ISSUES=$(jq '[.site[]?.alerts[]? | select(.riskcode == 3)] | length' zap_report.json || echo "0")
            MEDIUM_ISSUES=$(jq '[.site[]?.alerts[]? | select(.riskcode == 2)] | length' zap_report.json || echo "0")
            LOW_ISSUES=$(jq '[.site[]?.alerts[]? | select(.riskcode == 1)] | length' zap_report.json || echo "0")
            INFO_ISSUES=$(jq '[.site[]?.alerts[]? | select(.riskcode == 0)] | length' zap_report.json || echo "0")
            
            echo "high_issues=$HIGH_ISSUES" >> $GITHUB_OUTPUT
            echo "medium_issues=$MEDIUM_ISSUES" >> $GITHUB_OUTPUT
            echo "low_issues=$LOW_ISSUES" >> $GITHUB_OUTPUT
            echo "info_issues=$INFO_ISSUES" >> $GITHUB_OUTPUT
            
            # é‡å¤§ãªå•é¡ŒãŒã‚ã‚‹å ´åˆã¯å¤±æ•—ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            if [ "$HIGH_ISSUES" -gt 0 ]; then
              echo "has_critical_issues=true" >> $GITHUB_OUTPUT
            else
              echo "has_critical_issues=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "high_issues=0" >> $GITHUB_OUTPUT
            echo "medium_issues=0" >> $GITHUB_OUTPUT
            echo "low_issues=0" >> $GITHUB_OUTPUT
            echo "info_issues=0" >> $GITHUB_OUTPUT
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if ZAP report exists
        id: check_report
        if: always()
        run: |
          if [ -f zap_report.md ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update PR comment with detailed report
        if: always() && steps.check_report.outputs.exists == 'true' && github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.pr_number.outputs.pr_number }}
          body-path: zap_report.md
          edit-mode: replace
          comment-tag: zap-scan-results-preview

      - name: Post scan summary comment to PR
        if: always() && github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.pr_number.outputs.pr_number }}
          body: |
            ## ðŸ”’ OWASP ZAP Security Scan Results (Preview)
            
            **Deployment URL:** ${{ steps.target.outputs.url }}
            
            ### Scan Summary
            - ðŸ”´ **High Risk Issues:** ${{ steps.parse_results.outputs.high_issues }}
            - ðŸŸ¡ **Medium Risk Issues:** ${{ steps.parse_results.outputs.medium_issues }}
            - ðŸŸ  **Low Risk Issues:** ${{ steps.parse_results.outputs.low_issues }}
            - ðŸ”µ **Info Issues:** ${{ steps.parse_results.outputs.info_issues }}
            
            ${{ steps.parse_results.outputs.has_critical_issues == 'true' && '### âš ï¸ **WARNING: Critical security issues detected!**' || '### âœ… No critical security issues detected' }}
            
            ${{ steps.check_report.outputs.exists == 'true' && '**Detailed Report:** See the full report in the comment above or check the workflow artifacts for HTML/JSON reports.' || '**Note:** Detailed report is not available. Check the workflow artifacts for scan results.' }}
            
            ---
            *This scan was automatically triggered by the preview deployment.*
          edit-mode: replace
          comment-tag: zap-scan-summary-preview

      - name: Post production scan summary
        if: always() && steps.scan_env.outputs.environment == 'production'
        run: |
          echo "## ðŸ”’ OWASP ZAP Security Scan Results (Production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ steps.target.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ **High Risk Issues:** ${{ steps.parse_results.outputs.high_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¡ **Medium Risk Issues:** ${{ steps.parse_results.outputs.medium_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  **Low Risk Issues:** ${{ steps.parse_results.outputs.low_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”µ **Info Issues:** ${{ steps.parse_results.outputs.info_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.parse_results.outputs.has_critical_issues }}" == "true" ]; then
            echo "### âš ï¸ **WARNING: Critical security issues detected!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… No critical security issues detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical issues found
        if: steps.parse_results.outputs.has_critical_issues == 'true'
        run: |
          echo "Critical security issues detected. Failing the workflow."
          exit 1

