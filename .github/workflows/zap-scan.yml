name: OWASP ZAP Security Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        type: string

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: ZAP Scan
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Vercel Preview URL from PR comments
        id: vercel_url
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // VercelのプレビューURLをPRコメントから取得
            const vercelComment = comments.find(comment => 
              comment.body && comment.body.includes('vercel.app')
            );
            
            if (vercelComment) {
              const urlMatch = vercelComment.body.match(/https:\/\/[^\s]+\.vercel\.app/);
              if (urlMatch) {
                core.setOutput('url', urlMatch[0]);
                return;
              }
            }
            
            // コメントから取得できない場合、デフォルトのパターンを使用
            const prNumber = context.issue.number;
            const defaultUrl = `https://salmon-run-scenario-hub-git-${prNumber}-eddie-splatoons-projects.vercel.app`;
            core.setOutput('url', defaultUrl);

      - name: Set target URL
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ steps.vercel_url.outputs.url }}" >> $GITHUB_OUTPUT
          fi
          
          echo "Target URL: ${{ steps.target.outputs.url }}"

      - name: Wait for deployment
        if: github.event_name == 'pull_request'
        run: |
          echo "Waiting for Vercel deployment to be ready..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          TARGET_URL="${{ steps.target.outputs.url }}"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s -o /dev/null "$TARGET_URL"; then
              echo "Deployment is ready!"
              exit 0
            fi
            echo "Waiting for deployment... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          
          echo "Warning: Deployment may not be ready, proceeding with scan anyway"

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        continue-on-error: true
        with:
          target: ${{ steps.target.outputs.url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J'

      - name: Check if SARIF file exists
        id: check_sarif
        if: always()
        run: |
          if [ -f zap_report.sarif ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Archive ZAP results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: |
            zap_report.html
            zap_report.json
            zap_report.md
            zap_report.sarif
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload ZAP results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.check_sarif.outputs.exists == 'true'
        continue-on-error: true
        with:
          sarif_file: zap_report.sarif
          wait-for-processing: true

